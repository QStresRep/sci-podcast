name: Publish Podcast (normalize + feed + release)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g. v2025.09.26)'
        required: false
      title:
        description: 'Release title'
        required: false

permissions:
  contents: write

env:
  # 可按需改成你的站点根（必须是能公开访问的 HTTPS 域名，末尾带 /）
  PODCAST_SITE: https://qstresrep.github.io/sci-podcast/
  PODCAST_TITLE: QS-sci-podcast
  PODCAST_DESCRIPTION: Bulk Reading!
  PODCAST_AUTHOR: QS Sci
  PODCAST_OWNER_NAME: QS Sci
  PODCAST_OWNER_EMAIL: you@example.com      # 建议改成你自己的联系邮箱（Apple 要求）
  PODCAST_CATEGORY: Science                  # 可改：News, Education, Technology 等
  PODCAST_EXPLICIT: no                       # yes / no / clean

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      # ① 规范化 MP3（Apple Podcasts 友好：44.1kHz / 128k CBR / mono）
      - name: Normalize MP3 for Apple Podcasts
        run: |
          mkdir -p docs/audio_norm
          shopt -s nullglob
          for f in docs/audio/*_full.mp3; do
            base=$(basename "$f")
            ffmpeg -y -i "$f" -ar 44100 -ac 1 -b:a 128k -codec:a libmp3lame "docs/audio_norm/$base"
          done
          for f in docs/audio_norm/*_full.mp3; do
            base=$(basename "$f")
            mv -f "$f" "docs/audio/$base"
          done
          rmdir docs/audio_norm || true

      # ② 生成 RSS feed.xml（补齐 iTunes 标签 + 封面 + self 链接）
      - name: Generate docs/feed.xml
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import os, glob, time, subprocess, xml.sax.saxutils as xu, pathlib
          from urllib.parse import quote

          SITE_LINK = os.getenv("PODCAST_SITE", "").rstrip("/") + "/"
          TITLE     = os.getenv("PODCAST_TITLE", "Podcast")
          DESC      = os.getenv("PODCAST_DESCRIPTION", "")
          AUTHOR    = os.getenv("PODCAST_AUTHOR", "")
          OWNER_N   = os.getenv("PODCAST_OWNER_NAME", "")
          OWNER_E   = os.getenv("PODCAST_OWNER_EMAIL", "")
          CATEGORY  = os.getenv("PODCAST_CATEGORY", "Science")
          EXPLICIT  = os.getenv("PODCAST_EXPLICIT", "no").lower()  # yes/no/clean

          AUDIO_BASE = SITE_LINK + "audio/"
          FEED_URL   = SITE_LINK + "feed.xml"
          COVER_PATH = "docs/cover.png"  # 你已放在 docs/cover.png
          COVER_URL  = SITE_LINK + "cover.png" if pathlib.Path(COVER_PATH).exists() else ""

          def ffprobe_json(path):
              import json, subprocess
              out = subprocess.check_output(["ffprobe","-v","error","-print_format","json","-show_format",path], text=True)
              return json.loads(out)

          files = sorted(glob.glob("docs/audio/*_full.mp3"))
          items_xml = []
          for f in files:
              st = os.stat(f); size = st.st_size
              info = ffprobe_json(f)
              dur  = float(info.get("format", {}).get("duration", 0))
              h = int(dur // 3600); m = int((dur % 3600) // 60); s = int(dur % 60)
              itunes_dur = f"{h:01d}:{m:02d}:{s:02d}" if h else f"{m:02d}:{s:02d}"

              base = os.path.basename(f)
              title = os.path.splitext(base)[0]
              pub_ts = time.gmtime(st.st_mtime)
              pub_str = time.strftime("%a, %d %b %Y %H:%M:%S +0000", pub_ts)
              url = AUDIO_BASE + quote(base)

              items_xml.append(f"""
                <item>
                  <title>{xu.escape(title)}</title>
                  <itunes:title>{xu.escape(title)}</itunes:title>
                  <description>{xu.escape(title)}</description>
                  <enclosure url="{url}" length="{size}" type="audio/mpeg" />
                  <guid isPermaLink="false">{xu.escape(url)}</guid>
                  <pubDate>{pub_str}</pubDate>
                  <itunes:duration>{itunes_dur}</itunes:duration>
                  <itunes:episodeType>full</itunes:episodeType>
                  <itunes:explicit>{EXPLICIT}</itunes:explicit>
                </item>
              """.strip())

          # Channel 级别 RSS + iTunes 标签
          image_xml = f"""
            <image>
              <url>{xu.escape(COVER_URL)}</url>
              <title>{xu.escape(TITLE)}</title>
              <link>{xu.escape(SITE_LINK)}</link>
            </image>
          """.strip() if COVER_URL else ""

          itunes_image = f'<itunes:image href="{xu.escape(COVER_URL)}" />' if COVER_URL else ""

          rss = f"""<?xml version="1.0" encoding="UTF-8"?>
          <rss version="2.0"
               xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd"
               xmlns:atom="http://www.w3.org/2005/Atom">
            <channel>
              <title>{xu.escape(TITLE)}</title>
              <link>{xu.escape(SITE_LINK)}</link>
              <description>{xu.escape(DESC)}</description>
              <language>en-us</language>
              <lastBuildDate>{time.strftime("%a, %d %b %Y %H:%M:%S +0000", time.gmtime())}</lastBuildDate>
              <atom:link href="{xu.escape(FEED_URL)}" rel="self" type="application/rss+xml" />
              {image_xml}
              {itunes_image}
              <itunes:author>{xu.escape(AUTHOR)}</itunes:author>
              <itunes:owner>
                <itunes:name>{xu.escape(OWNER_N)}</itunes:name>
                <itunes:email>{xu.escape(OWNER_E)}</itunes:email>
              </itunes:owner>
              <itunes:category text="{xu.escape(CATEGORY)}" />
              <itunes:explicit>{EXPLICIT}</itunes:explicit>
              {''.join(items_xml)}
            </channel>
          </rss>
          """
          pathlib.Path("docs/feed.xml").write_text(rss, encoding="utf-8")
          print(f"[OK] wrote docs/feed.xml with {len(files)} item(s); cover={'yes' if COVER_URL else 'no'}")
          PY

      # ③ 提交规范化后的 mp3 和 feed.xml
      - name: Commit normalized audio & feed
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add docs/audio docs/feed.xml
          git commit -m "Normalize audio + update feed (with itunes & cover)" || echo "No changes"
          git push

      # ④ 创建 Release 并附带 mp3
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag || format('v{0}', github.run_id) }}
          name: ${{ github.event.inputs.title || 'Podcast Audio' }}
          files: |
            docs/audio/*_full.mp3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
